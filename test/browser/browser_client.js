!function(){function t(){var t=this;s||(t.constants=require("./constants"),t.utils=require("./services/utils/shared")),t.constants={ERROR_TYPE:{NOT_FOUND:404,SYSTEM:500,ACCESS_DENIED:403,INVALID_CREDENTIALS:401},CONSISTENCY:{QUEUED:0,DEFERRED:1,TRANSACTIONAL:2,ACKNOWLEDGED:3},CLIENT_STATE:{UNINITIALIZED:0,ACTIVE:1,DISCONNECTED:2,ERROR:3,RECONNECTING:4,CONNECTING:5,CONNECTED:6,DISCONNECTING:7,CONNECT_ERROR:8},CONNECTION_POOL_TYPE:{ORDERED:0,RANDOM:1},SYSTEM_HEALTH:{EXCELLENT:0,FAIR:1,TAKING_STRAIN:2,POOR:3},ERROR_SEVERITY:{LOW:0,MEDIUM:1,HIGH:2,FATAL:3}},t.utils={prepareWildPath:function(t){if(!t)return"";for(var e="",n=null,o=0;o<t.length;o++)("*"!=t[o]||"*"!=n)&&(e+=t[o],n=t[o]);return e},makeRe:function(t){return new RegExp("^"+this.escapeRegex(t).replace(/\\\*/g,".*")+"$","i")},escapeRegex:function(t){if("string"!=typeof t)throw new TypeError("Expected a string");return t.replace(/[|\\{}()[\]^$+*?.]/g,"\\//{{utils}}")},wildcardMatch:function(t,e){if(-1==t.indexOf("*"))return t==e;var n=this.prepareWildPath(t);return"*"==n?!0:n==e?!0:this.makeRe(n).test(e)},whilst:function(t,e,n){if(n=n||noop,!t())return n(null);var o=this;o.__attempts=0;var r=function(i,s){return o.__attempts++,i?n(i,o.__attempts):t.apply(this,s)?e(o.__attempts,r):void n.apply(null,[null].concat(s,o.__attempts))}.bind(o);e(o.__attempts,r)},async:function(t,e,n,o){var r,i,s,a=0,c=0,u=t.length-1,l=!1;if("number"==typeof e?(r=e,s=n,i=o||function(){}):(s=e,i=n||function(){},r=t.length),!t.length)return i();var p=s.length,f=function(){return!l&&r>a&&u>c},d=function(t){l||(a--,t||c===u&&!a?(l=!0,i(t)):f()&&h(++c))},h=function y(){a++;var e=2===p?[t[c],d]:[t[c],c,d];s.apply(null,e),f()&&y(++c)};h()},clone:function(t){return JSON.parse(JSON.stringify(t))},checkPath:function(t,e){if("set"==e&&t.indexOf("*")>-1)throw new Error("Bad path, if the action is 'set' the path cannot contain the * wildcard character");if(null==t.match(/^[a-zA-Z0-9\/(\/)\/+\/=\/&\/:%@.\/\/_*\/-\s]+$/))throw new Error("Bad path, can only contain characters a-z A-Z 0-9 / & + = : @ % * ( ) _ -, ie: factory1@I&J(western-cape)/plant1:conveyer_2/stats=true/capacity=10%/*")},removeLeading:function(t,e){if(null===e||void 0===e)return e;if(null==t)return e;if(""==t)return e;var n=e.toString();return 0==n.indexOf(t)&&(n=n.substring(1,n.length)),n},removeLast:function(t,e){if(null===e||void 0===e)return e;if(null==t)return e;if(""==t)return e;var n=e.toString();return n[n.length-1]==t&&(n=n.substring(0,n.length-1)),n}},i=t.constants.CLIENT_STATE}var e,n,o,r,i,s=!1,a="happn_3";"undefined"!=typeof window&&"undefined"!=typeof document&&(s=!0),"undefined"!=typeof module&&(module.exports=t),s?(window.HappnClient=t,r=window.Primus,e&&"function"==typeof e.promisify||(e=e||{},e.promisify=function(t){return t})):(e=require("bluebird"),n=require("happn-logger"),a="happn_"+require("../package.json").protocol,r=require("happn-primus"));var c=function(t,n){return function(){var o=Array.prototype.slice.call(arguments),r=this;return n&&n.unshift&&o.unshift(n.unshift),"function"==typeof o[o.length-1]?t.apply(this,o):new e(function(e,n){o.push(function(t,o,r){if(t)return n(t);if(r){var i=Array.prototype.slice.call(arguments);return i.shift(),e(i)}return e(o)});try{return t.apply(r,o)}catch(i){return n(i)}})}},u=function(t){if(null==t)return!1;var e=t.config?t.config:t,n=!1,o=!1;if(e.host&&null!=e.host.range){if(!Array.isArray(e.host.range)||2!=e.host.range.length)throw new Error("invalid range option, range must be an array or length must be 2");n=!0}if(e.port&&null!=e.port.range){if(!Array.isArray(e.port.range)||2!=e.port.range.length)throw new Error("invalid range option, range must be an array or length must be 2");o=!0}if(n&&o)throw new Error("invalid range option, range can only be by host or port, not both");return n||o?!0:!1},l=function(t){var e=[],n=t.config?t.config:t,o=JSON.stringify(n);n.port||(n.port=55e3),n.host||(n.host="127.0.0.1");var r=function(t,n){var r=JSON.parse(o);r.host=t,r.port=n,e.push(r)};if(null!=n.host.range)for(var i=n.host.range[0].split("."),s=n.host.range[1].split("."),a=i[3],c=s[3],u=a;c>=u;u++)256>u&&r(i.slice(0,3).join(".")+"."+u,n.port);if(null!=n.port.range)for(var l=n.port.range[0];l<=n.port.range[1];l++)r(n.host,l);return e};t.__instance=function(e){return(new t).client(e)};var p=function(t,e){null==e&&(e={}),Array.isArray(t)&&(e.pool=t),u(t)&&(e.pool=l(t));try{null!=t&&"{}"==JSON.stringify(e)&&(e=t)}catch(n){}return e};t.__prepareOptions=p,t.create=c(function(e,n,o){"function"==typeof e&&(o=e,n={},e=null),"function"==typeof n&&(o=n,n=e?e:{},e=null);var r;try{r=p(e,n)}catch(i){return o(i)}var s=(new t).client(r);return r.testMode&&(t.lastClient=s),s.initialize(function(t,e){return t?"eventemitter"!==s.state.clientType?s.disconnect(function(){o(t)}):(s.socket.disconnect(),void o(t)):o(null,e)})}),t.prototype.client=function(t){var e=this;return t=t||{},t.Logger&&t.Logger.createLogger?this.log=t.Logger.createLogger("HappnClient"):n?(n.configured||n.configure(t.utils),this.log=n.createLogger("HappnClient")):this.log={$$TRACE:function(t,e){return e?console.info("HappnClient",t,e):void console.info("HappnClient",t)},$$DEBUG:function(t,e){return e?console.info("HappnClient",t,e):void console.info("HappnClient",t)},trace:function(t,e){return e?console.info("HappnClient",t,e):void console.info("HappnClient",t)},debug:function(t,e){return e?console.info("HappnClient",t,e):void console.info("HappnClient",t)},info:function(t,e){return e?console.info("HappnClient",t,e):void console.info("HappnClient",t)},warn:function(t,e){return e?console.warn("HappnClient",t,e):void console.info("HappnClient",t)},error:function(t,e){return e?console.error("HappnClient",t,e):void console.info("HappnClient",t)},fatal:function(t,e){return e?console.error("HappnClient",t,e):void console.info("HappnClient",t)}},this.log.$$TRACE("new client()"),this.__initializeState(),this.__initializeConnectivity(),this.__prepareOptions(t),this.__initializeEvents(),e},t.prototype.initialize=c(function(t){var e=this;return e.session=null,s?e.getResources(function(n){return n?t(n):void e.authenticate(function(n){return n?t(n):(e.status=i.ACTIVE,void t(null,e))})}):void e.authenticate(function(n){return n?t(n):(e.status=i.ACTIVE,void t(null,e))})}),t.prototype.__prepareSecurityOptions=function(t){t.keyPair&&t.keyPair.publicKey&&(t.publicKey=t.keyPair.publicKey),t.keyPair&&t.keyPair.privateKey&&(t.privateKey=t.keyPair.privateKey)},t.prototype.__prepareSocketOptions=function(t){t.socket||(t.socket={}),t.socket.reconnect||(t.socket.reconnect={}),t.reconnect&&(t.socket.reconnect=t.reconnect),t.socket.reconnect.retries||(t.socket.reconnect.retries=1/0),t.socket.reconnect.max||(t.socket.reconnect.max=18e4),t.socket.timeout=t.connectTimeout?t.connectTimeout:3e4,t.socket.timeout||(t.socket.timeout=1e4),t.socket.reconnect.strategy&&(t.socket.strategy=t.socket.reconnect.strategy),t.socket.strategy||(t.socket.strategy="disconnect,online,timeout")},t.prototype.__prepareConnectionOptions=function(t,e){var n=function(n){t[n]||null==e[n]||(t[n]=e[n])};return e&&(n("host"),n("port"),n("url"),n("protocol"),n("allowSelfSignedCerts"),n("username"),n("password"),n("publicKey"),n("privateKey"),n("token")),t.host||(t.host="127.0.0.1"),t.port||(t.port=55e3),t.url||(t.protocol=t.protocol||"http","http"==t.protocol&&80==parseInt(t.port)?t.url=t.protocol+"://"+t.host:"https"==t.protocol&&443==parseInt(t.port)?t.url=t.protocol+"://"+t.host:t.url=t.protocol+"://"+t.host+":"+t.port),t},t.prototype.__prepareOptions=function(t){var e;if(t.config){e=t.config;for(var n in t)"config"==n||e[n]||(e[n]=t[n])}else e=t;if(e.callTimeout||(e.callTimeout=6e4),e.context&&Object.defineProperty(this,"context",{value:e.context}),e.plugin)for(var o in e.plugin)e.plugin.hasOwnProperty(o)&&(e.plugin[o].bind?this[o]=e.plugin[o].bind(this):this[o]=e.plugin[o]);if(e.pool){var r=this;e.poolReconnectDelay||(e.poolReconnectDelay=0),null==e.poolType&&(e.poolType=r.constants.CONNECTION_POOL_TYPE.RANDOM),null==e.poolReconnectAttempts&&(e.poolReconnectAttempts=4),e.pool=e.pool.map(function(t){return r.__prepareConnectionOptions(t.config?t.config:t,e)})}else e=this.__prepareConnectionOptions(e);this.__prepareSecurityOptions(e),e.allowSelfSignedCerts&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),this.__prepareSocketOptions(e);var i=null!=e.info?e.info:{};"object"!=typeof i&&(i={data:i}),e.info=i,e.info._browser=s,null==e.loginRetry&&(e.loginRetry=4),null==e.loginRetryInterval&&(e.loginRetryInterval=5e3),null==e.loginTimeout&&(e.loginTimeout=e.callTimeout),this.options=e},t.prototype.__updateOptions=function(t){var e=this,n=function(n){null!=t[n]&&(e.options[n]=t[n])};n("url"),n("host"),n("port"),n("protocol"),n("allowSelfSignedCerts"),n("username"),n("password"),n("publicKey"),n("privateKey"),n("token")},t.prototype.__initializeConnectivity=function(){var t=this;t.initializeConnectionPool=function(e){t.__tried=[],t.__possible=t.options.pool.map(function(t){return t}),e&&(t.__poolAttempts=0)},t.__getConnection=function(e){t.__connectionCleanup(),t.options.socket.manual=!0;try{if(t.options.pool){var n=!1;if(t.__tried?t.__poolAttempts++:t.initializeConnectionPool(!0),t.options.poolReconnectAttempts>0&&t.__poolAttempts>t.options.poolReconnectAttempts)return e(new Error("pool reconnection attempts exceeded"));0==t.__possible.length&&(t.initializeConnectionPool(),n=!0);var o;if(t.options.poolType==t.constants.CONNECTION_POOL_TYPE.RANDOM&&(o=Math.floor(Math.random()*t.__possible.length)),t.options.poolType==t.constants.CONNECTION_POOL_TYPE.ORDERED&&(o=0),t.__updateOptions(t.__possible[o]),t.__tried.push(t.__possible[o]),t.__possible.splice(o,1),n)return setTimeout(function(){t.__connectSocket(e)},t.options.poolReconnectDelay);t.__connectSocket(e)}else t.__connectSocket(e)}catch(r){e(r)}}},t.prototype.__connectSocket=function(t){var e,n=this;if(n.status=i.CONNECTING,s)e=new r(n.options.url,n.options.socket);else{var o=r.createSocket({transformer:n.options.transformer,parser:n.options.parser,manual:!0});e=new o(n.options.url,n.options.socket)}e.on("timeout",function(){return n.status===i.CONNECTING?n.options.pool?n.__getConnection(t):(n.status=i.CONNECT_ERROR,t(new Error("connection timed out"))):void n.handle_error(new Error("connection timed out"))}),e.on("open",function a(){n.status===i.CONNECTING&&(n.status=i.ACTIVE,n.serverDisconnected=!1,e.removeListener("open",a),n.options.pool&&n.initializeConnectionPool(!0),t(null,e))}),e.on("error",function(e){if(n.status===i.CONNECTING){if(n.options.pool)return n.__getConnection(t);n.status=i.CONNECT_ERROR,t(e)}n.handle_error(e)}),e.open()},t.prototype.__initializeState=function(){var t=this;t.state={},t.state.events={},t.state.refCount={},t.state.listenerRefs={},t.state.requestEvents={},t.state.currentEventId=0,t.state.currentListenerId=0,t.state.errors=[],t.state.clientType="socket",t.state.systemMessageHandlers=[],t.status=i.UNINITIALIZED,t.state.ackHandlers={},t.state.eventHandlers={}},t.prototype.__initializeEvents=function(){var t=this;t.onEvent=function(e,n){if(!e)throw new Error("event name cannot be blank or null");if("function"!=typeof n)throw new Error("event handler must be a function");return t.state.eventHandlers[e]||(t.state.eventHandlers[e]=[]),t.state.eventHandlers[e].push(n),e+"|"+(t.state.eventHandlers[e].length-1)},t.offEvent=function(e){var n=e.split("|")[0],o=parseInt(e.split("|")[1]);t.state.eventHandlers[n][o]=null},t.emit=function(e,n){t.state.eventHandlers[e]&&t.state.eventHandlers[e].forEach(function(t){t&&t.call(t,n)})}},t.prototype.getScript=function(t,e){if(!s)return e(new Error("only for browser"));var n=document.createElement("script");n.src=t;var o=document.getElementsByTagName("head")[0],r=!1;n.onload=n.onreadystatechange=function(){r||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(r=!0,n.onload=n.onreadystatechange=null,o.removeChild(n),e())},o.appendChild(n)},t.prototype.getResources=function(t){var e=this;"undefined"==typeof r?e.getScript(e.options.url+"/browser_primus.js",function(e){if(e)return t(e);if("undefined"==typeof r){if(window&&window.Primus)r=window.Primus;else{if(!document||!document.Primus)return t(new Error("unable to fetch Primus library"));r=document.Primus}t()}}):t()},t.prototype.stop=c(function(t){this.__connectionCleanup()}),t.prototype.__encryptLogin=function(t,e){return{encrypted:o.asymmetricEncrypt(e,this.options.privateKey,JSON.stringify(t)),publicKey:t.publicKey,loginType:null!=t.loginType?t.loginType:"password"}},t.prototype.__decryptLogin=function(t){try{return JSON.parse(o.asymmetricDecrypt(this.serverInfo.publicKey,this.options.privateKey,t.encrypted))}catch(e){throw e}},t.prototype.__encryptPayload=function(t){return{sessionId:t.sessionId,eventId:t.eventId,encrypted:o.symmetricEncryptObject(t,this.session.secret)}},t.prototype.__decryptPayload=function(t){var e=o.symmetricDecryptObject(t,this.session.secret);return e},t.prototype.__ensureCryptoLibrary=c(function(t){return o?t():void(s?this.getScript(this.options.url+"/browser_crypto.js",function(e){return e?t(e):(o=new window.Crypto,void t())}):(Crypto=require("happn-util-crypto"),o=new Crypto,t()))}),t.prototype.__attachSession=function(t){if(delete t._meta,this.session=t,s){var e=(t.cookieName||"happn_token")+"="+this.session.token+"; path=/;";t.cookieDomain&&(e+=" domain="+t.cookieDomain+";"),document.cookie=e}},t.prototype.__payloadToError=function(t){var e=new Error(t.toString());return t.message&&(e.message=t.message),e},t.prototype.__doLogin=function(t,e){var n=this,o=function(e){n.__performSystemRequest("login",t,{timeout:n.options.loginTimeout},function(t,o){return t?e(t):void("ok"==o._meta.status?(n.__attachSession(o),e()):e(n.__payloadToError(o.payload)))})};if(!n.options.loginRetry)return o(e);n.options.loginRetryInterval&&"number"==typeof n.options.loginRetryInterval||(n.options.loginRetryInterval=5e3);var r=0,i=!1;n.utils.whilst(function(){return r<n.options.loginRetry&&0==i},function(t,e){r++,o(function(t){return t?[403,401].indexOf(t.code)>-1?e(t):r==n.options.loginRetry?e(t):setTimeout(e,n.options.loginRetryInterval):(i=!0,e())})},e)},t.prototype.__signNonce=function(t){return o.sign(t,this.options.privateKey)},t.prototype.__prepareLogin=function(t,e){var n=this,o=function(t){n.serverInfo.encryptPayloads&&(t=n.__encryptLogin(t,n.serverInfo.publicKey)),e(null,t)};"digest"==t.loginType?n.__performSystemRequest("request-nonce",{publicKey:t.publicKey},null,function(r,i){return r?e(r):(t.digest=n.__signNonce(i.nonce),void o(t))}):o(t)},t.prototype.login=c(function(t){var e=this,n={username:this.options.username,info:this.options.info,protocol:a};n.info._browser=s,n.info._local=e.socket._local?!0:!1,this.options.password&&(n.password=this.options.password),this.options.publicKey&&(n.publicKey=this.options.publicKey),this.options.token&&(n.token=this.options.token),"happn_{{protocol}}"===a&&(a="happn"),e.__performSystemRequest("configure-session",{protocol:a},null,function(r){return r?t(r):void e.__performSystemRequest("describe",null,null,function(r,i){if(r)return t(r);if(e.serverInfo=i,e.serverInfo.secure){if(!n.token&&!n.username)return t(new Error("happn server is secure, please specify a username or token"));if(!n.password&&!n.token){if(!n.publicKey)return t(new Error("happn server is secure, please specify a password"));n.loginType="digest"}e.serverInfo.encryptPayloads||"digest"===n.loginType?e.__ensureCryptoLibrary(function(r){if(r)return t(r);if(!e.options.privateKey||!e.options.publicKey){if("digest"===n.loginType)return t(new Error("login type is digest, but no privateKey and publicKey specified"));var i=o.createKeyPair();e.options.publicKey=i.publicKey,e.options.privateKey=i.privateKey}n.publicKey=e.options.publicKey,e.__prepareLogin(n,function(n,o){return n?t(n):void e.__doLogin(o,t)})}):e.__doLogin(n,t)}else e.__doLogin(n,t)})})}),t.prototype.authenticate=c(function(t){var e=this;return e.socket?void e.login(t):void e.__getConnection(function(n,o){return n?t(n):(e.socket=o,e.socket.on("data",e.handle_publication.bind(e)),e.socket.on("reconnected",e.reconnect.bind(e)),e.socket.on("end",e.handle_end.bind(e)),e.socket.on("close",e.handle_end.bind(e)),e.socket.on("reconnect timeout",e.handle_reconnect_timeout.bind(e)),e.socket.on("reconnect scheduled",e.handle_reconnect_scheduled.bind(e)),void e.login(t))})}),t.prototype.handle_end=function(){return this.status=i.DISCONNECTED,this.session?this.emit("connection-ended",this.session.id):void this.emit("connection-ended")},t.prototype.handle_reconnect_timeout=function(t,e){this.status=i.DISCONNECTED,this.emit("reconnect-timeout",{err:t,opts:e})},t.prototype.handle_reconnect_scheduled=function(t){var e=this;e.status=i.RECONNECTING,e.__reconnectSuccessful=!1,e.emit("reconnect-scheduled",t),e.options.pool&&(e.socket=null,e.reconnect(function(t){t&&e.handle_error(new Error("pooled subscription reconnection failed",t))}))},t.prototype.getEventId=function(){return this.state.currentEventId+=1},t.prototype.__requestCallback=function(t,e,n,o,r,i){var s=this,a={eventId:t.eventId};a.handleResponse=function(t,n){return clearTimeout(a.timedout),delete s.state.requestEvents[a.eventId],e(t,n)},a.timedout=setTimeout(function(){delete s.state.requestEvents[a.eventId];var t="api request timed out";return r&&(t+=" path: "+r),i&&(t+=" action: "+i),e(new Error(t))},n.timeout),s.state.requestEvents[o]=a},t.prototype.__asyncErrorCallback=function(t,e){if(!e)throw t;setImmediate(function(){e(t)})},t.prototype.__performDataRequest=function(t,e,n,o,r){if(this.status!=i.ACTIVE){var s="client not active";this.status===i.CONNECT_ERROR&&(s="client in an error state"),this.status===i.ERROR&&(s="client in an error state"),this.status===i.UNINITIALIZED&&(s="client not initialized yet"),this.status===i.DISCONNECTED&&(s="client is disconnected");var a="action: "+e+", path: "+t,c=new Error(s);return c.detail=a,this.__asyncErrorCallback(c,r)}var u={action:e,eventId:this.getEventId(),path:t,data:n,sessionId:this.session.id};o?u.options=o:o={},["set","remove"].indexOf(e)>=0&&(o.consistency==this.constants.CONSISTENCY.DEFERRED||o.consistency==this.constants.CONSISTENCY.ACKNOWLEDGED)&&this.__attachPublishedAck(o,u),o.timeout||(o.timeout=this.options.callTimeout),this.serverInfo.encryptPayloads&&(u=this.__encryptPayload(u)),r&&this.__requestCallback(u,r,o,u.eventId,t,e),this.socket.write(u)},t.prototype.__performSystemRequest=function(t,e,n,o){var r={action:t,eventId:this.getEventId()};void 0!=e&&(r.data=e),this.session&&(r.sessionId=this.session.id),n?r.options=n:n={},n.timeout||(n.timeout=this.options.callTimeout),this.__requestCallback(r,o,n,r.eventId),this.socket.write(r)},t.prototype.getChannel=function(t,e){return this.utils.checkPath(t),"/"+e.toUpperCase()+"@"+t},t.prototype.get=c(function(t,e,n){"function"==typeof e&&(n=e,e={}),this.__performDataRequest(t,"get",null,e,n)}),t.prototype.getPaths=c(function(t,e){this.get(t,{options:{path_only:!0}},e)}),t.prototype.increment=c(function(t,e,n,o){return"function"==typeof n&&(o=n,n=e,e="counter"),"function"==typeof e&&(o=e,n=1,e="counter"),isNaN(n)?o(new Error("increment must be a number")):void this.set(t,e,{increment:n},o)}),t.prototype.set=c(function(t,e,n,o){"function"==typeof n&&(o=n,n={}),null===e&&(n.nullValue=!0);try{this.utils.checkPath(t,"set"),this.__performDataRequest(t,"set",e,n,o)}catch(r){return o(r)}}),t.prototype.setSibling=c(function(t,e,n){this.set(t,e,{set_type:"sibling"},n)}),t.prototype.remove=c(function(t,e,n){return"function"==typeof e&&(n=e,e={}),this.__performDataRequest(t,"remove",null,e,n)}),t.prototype.__updateListenerRef=function(t,e){t.initialEmit||t.initialCallback?this.state.listenerRefs[t.id]=e:this.state.listenerRefs[t.eventKey]=e},t.prototype.__clearListenerRef=function(t){return t.initialEmit||t.initialCallback?delete this.state.listenerRefs[t.id]:void delete this.state.listenerRefs[t.eventKey]},t.prototype.__getListenerRef=function(t){return t.initialEmit||t.initialCallback?this.state.listenerRefs[t.id]:this.state.listenerRefs[t.eventKey]},t.prototype.__reattachListeners=function(t){var e=this;e.utils.async(Object.keys(e.state.events),function(t,n,o){var r=e.state.events[t];e.state.refCount={},e.utils.async(r,function(n,o,r){if(e.state.refCount[n.eventKey])return e.state.refCount[n.eventKey]++,r();var i={};n.meta&&(i.meta=n.meta),e._remoteOn(t,i,function(o,i){return o?r(new Error("failed re-establishing listener to path: "+t,o)):(e.state.refCount[n.eventKey]=1,e.__updateListenerRef(n,i.id),void r())})},o)},t)},t.prototype.reconnect=function(t){var e=this;e.status=i.ACTIVE,e.emit("reconnect",t),e.authenticate(function(n){return e.__reconnectSuccessful?void 0:n?n.message&&0==n.message.indexOf("api request timed out")?e.reconnect():e.handle_error(n,!0):void e.__reattachListeners(function(n){return n?e.handle_error(n,!0):(e.__reconnectSuccessful=!0,void e.emit("reconnect-successful",t))})})},t.prototype.handle_error=function(t,e){var n={timestamp:Date.now(),error:t,fatal:e||!1};100==this.state.errors.length&&this.state.errors.shift(),this.state.errors.push(n),1==e?(this.status=i.ERROR,this.emit("fatal-error",t)):this.emit("error",t),this.log.error("unhandled error",t)},t.prototype.__attachPublishedAck=function(t,e){var n=this;if("function"!=typeof t.onPublished)throw new Error("onPublish handler in options is missing");var o=t.onPublishedTimeout||6e4,r={id:e.sessionId+"-"+e.eventId,onPublished:t.onPublished,handle:function(t,e){clearTimeout(r.timeout),delete n.state.ackHandlers[r.id],r.onPublished(t,e)},timedout:function(){r.handle(new Error("publish timed out"))}};r.timeout=setTimeout(r.timedout,o),n.state.ackHandlers[r.id]=r},t.prototype.handle_ack=function(t){var e=this;if(e.state.ackHandlers[t.id]){if("error"==t.status)return e.state.ackHandlers[t.id].handle(new Error(t.error),t.result);e.state.ackHandlers[t.id].handle(null,t.result)}},t.prototype.handle_publication=function(t){if(t.encrypted&&(t=t._meta&&"login"==t._meta.type?this.__decryptLogin(t):this.__decryptPayload(t.encrypted)),t._meta&&"data"==t._meta.type)return this.handle_data(t._meta.channel,t);if(t._meta&&"system"==t._meta.type)return this.__handleSystemMessage(t);if(t._meta&&"ack"==t._meta.type)return this.handle_ack(t);if(Array.isArray(t))return this.handle_response_array(null,t,t.pop());if("error"==t._meta.status){var e=t._meta.error,n=new Error;return n.name=e.name||e.message||e,Object.keys(e).forEach(function(t){n[t]||(n[t]=e[t])}),this.handle_response(n,t)}var o;t.data?(o=t.data,o._meta=t._meta):o=t,null===t.data&&(o._meta.nullData=!0),this.handle_response(null,o)},t.prototype.handle_response_array=function(t,e,n){var o=this.state.requestEvents[n.eventId];o&&o.handleResponse(t,e)},t.prototype.handle_response=function(t,e){var n=this.state.requestEvents[e._meta.eventId];if(n){if(e._meta.nullData)return n.handleResponse(t,null);n.handleResponse(t,e)}},t.prototype.__acknowledge=function(t,e){return t._meta.consistency!==this.constants.CONSISTENCY.ACKNOWLEDGED?e(t):void this.__performDataRequest(t.path,"ack",t._meta.publicationId,null,function(n){n?(t._meta.acknowledged=!1,t._meta.acknowledgedError=n):t._meta.acknowledged=!0,e(t)})},t.prototype.delegate_handover=function(t,e){var n=this;if(!(e.count>0&&e.runcount>=e.count))return e.runcount++,e.count>0&&e.count==e.runcount?n._offListener(e.id,function(o){return o?n.handle_error(o):void e.handler.call(n,t.data,t._meta)}):void e.handler.call(n,t.data,t._meta)},t.prototype.handle_data=function(t,e){var n=this;n.__acknowledge(e,function(e){if(n.state.events[t]){if(e._meta.acknowledgedError&&n.log.error("acknowledgement failure: ",e._meta.acknowledgedError.toString(),e._meta.acknowledgedError),1==n.state.events[t].length)return n.delegate_handover(e,n.state.events[t][0]);var o=JSON.stringify(e);n.state.events[t].forEach(function(t){n.delegate_handover(JSON.parse(o),t)})}})},t.prototype.__clearSubscriptionsOnPath=function(t){var e=this,n=this.state.events[t];n.forEach(function(n){e.__clearListenerState(t,n)})},t.prototype.__clearSecurityDirectorySubscriptions=function(t){var e=this;Object.keys(this.state.events).forEach(function(n){t==n.substring(n.indexOf("@")+1)&&e.__clearSubscriptionsOnPath(n)})},t.prototype.__updateSecurityDirectory=function(t){var e=this;return"permission-removed"==t.data.whatHappnd&&["*","on"].indexOf(t.data.action)?this.__clearSecurityDirectorySubscriptions(t.data.changedData.path):void("upsert-group"==t.data.whatHappnd&&Object.keys(t.data.changedData.permissions).forEach(function(n){var o=t.data.changedData.permissions[n];return o.prohibit&&(o.prohibit.indexOf("on")>-1||o.prohibit.indexOf("*")>-1)?e.__clearSecurityDirectorySubscriptions(n):void 0}))},t.prototype.__handleSystemMessage=function(t){"server-side-disconnect"==t.eventKey&&(this.status=i.DISCONNECTED),"security-data-changed"==t.eventKey&&this.__updateSecurityDirectory(t),this.state.systemMessageHandlers.every(function(e){return e.apply(e,[t.eventKey,t.data])})},t.prototype.offSystemMessage=function(t){this.state.systemMessageHandlers.splice(t,1)},t.prototype.onSystemMessage=function(t){return this.state.systemMessageHandlers.push(t),this.state.systemMessageHandlers.length-1},t.prototype._remoteOn=function(t,e,n){this.__performDataRequest(t,"on",null,e,n)},t.prototype.__clearListenerState=function(t,e){this.state.events[t].splice(this.state.events[t].indexOf(e),1),0==this.state.events[t].length&&delete this.state.events[t],this.state.refCount[e.eventKey]--,0==this.state.refCount[e.eventKey]&&delete this.state.refCount[e.eventKey],this.__clearListenerRef(e)},t.prototype.on=c(function(t,e,n,o){var r=this;if("function"==typeof e&&(o=n,n=e,e={}),e||(e={}),e.event_type&&"*"!=e.event_type||(e.event_type="all"),e.count||(e.count=0),!o){if("function"!=typeof e.onPublished)throw new Error("you cannot subscribe without passing in a subscription callback");if("function"!=typeof n)throw new Error("callback cannot be null when using the onPublished event handler");o=n,n=e.onPublished}t=r.getChannel(t,e.event_type);var i={handler:n,count:e.count,eventKey:JSON.stringify({path:t,event_type:e.event_type,count:e.count,initialEmit:e.initialEmit,initialCallback:e.initialCallback,meta:e.meta}),runcount:0,meta:e.meta,id:r.state.currentListenerId++,initialEmit:e.initialEmit,initialCallback:e.initialCallback};return r.state.events[t]||(r.state.events[t]=[]),r.state.events[t].push(i),r.state.refCount[i.eventKey]||(r.state.refCount[i.eventKey]=0),r.state.refCount[i.eventKey]++,1==r.state.refCount[i.eventKey]||i.initialCallback||i.initialEmit?r._remoteOn(t,e,function(n,s){return n||"error"==s.status?(r.__clearListenerState(t,i),o("error"==s.status?s.payload:n)):(i.initialEmit||i.initialCallback?(i.initialEmit&&s.forEach(function(t){i.handler(t)}),r.__updateListenerRef(i,s._meta.referenceId)):r.__updateListenerRef(i,s.id),e.onPublished?o(null,i.id):i.initialCallback?o(null,i.id,s):o(null,i.id))}):void o(null,i.id)}),t.prototype.onAll=c(function(t,e){this.on("*",null,t,e)}),t.prototype._remoteOff=function(t,e,n){"function"==typeof e&&(n=e,e=0),this.__performDataRequest(t,"off",null,{referenceId:e},function(t,e){return t?n(t):"error"==e.status?n(e.payload):void n()})},t.prototype._offListener=function(t,e){var n=this;if(!n.state.events||0==n.state.events.length)return e();var o=!1;return Object.keys(n.state.events).every(function(r){var i=n.state.events[r];return i.every(function(i){if(i.id!=t)return!0;o=!0;var s=n.__getListenerRef(i);return n.__clearListenerState(r,i),!n.state.refCount[i.eventKey]||i.initialEmit||i.initialCallback?n._remoteOff(r,s,e):e(),!1})}),o?void 0:e()},t.prototype._offPath=function(t,e){var n=this,o=[],r=[];return Object.keys(n.state.events).forEach(function(e){var i=e.split("@"),s=i.slice(1,i.length).join("@");n.utils.wildcardMatch(t,s)&&(r.push(e),n.state.events[e].forEach(function(t){o.push(t)}))}),0==o.length?e():void n.utils.async(o,function(t,e,o){n._offListener(t.id,o)},function(t){return t?e(t):(r.forEach(function(t){delete n.state.events[t]}),void e())})},t.prototype.offAll=c(function(t){var e=this;return e._remoteOff("*",function(n){return n?t(n):(e.state.events={},e.state.refCount={},e.state.listenerRefs={},void t())})}),t.prototype.off=c(function(t,e){return null==t?e(new Error("handle cannot be null")):"number"!=typeof t?e(new Error("handle must be a number")):void this._offListener(t,e)}),t.prototype.offPath=c(function(t,e){return"function"==typeof t&&(e=t,t="*"),this._offPath(t,e)}),t.prototype.clearTimeouts=function(){var t=this;Object.keys(t.state.ackHandlers).forEach(function(e){clearTimeout(t.state.ackHandlers[e].timedout)}),Object.keys(t.state.requestEvents).forEach(function(e){clearTimeout(t.state.requestEvents[e].timedout)})},t.prototype.__connectionCleanup=function(t){try{if(this.socket){var e=this;if(t&&t.revokeSession)return e.revokeSession(function(t){t&&e.log.warn("socket.end failed in client, revoke session failed: "+t.toString()),e.socket.removeAllListeners("end"),e.socket.end()});this.socket.removeAllListeners("end"),this.socket.end()}}catch(n){this.log.warn("socket.end failed in client: "+n.toString())}},t.prototype.revokeSession=c(function(t){this.__performSystemRequest("revoke-session",null,null,t)}),t.prototype.disconnect=c(function(t,e){try{"function"==typeof t&&(e=t,t=null),t||(t={}),e||(e=function(){}),this.clearTimeouts(),this.__connectionCleanup(t),this.state.systemMessageHandlers=[],this.state.eventHandlers={},this.state.events={},this.state.refCount={},this.state.listenerRefs={},this.status=i.DISCONNECTED,e()}catch(n){e(n)}})}();